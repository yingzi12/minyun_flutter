<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xinshijie.gallery.mapper.UserAlbumMapper">

    <sql id="selectUserAlbum">
        select id,
               title,
               create_time,
               update_time,
               user_id,
               user_name,
               intro,
               tags,
               vip_price,
               charge,
               price,
               discount,
               girl,
               count_see,
               number_photos,
               number_video,
               count_collection,
               count_buy,
               score,
               introduce,
               status,
                charge,
               img_url,
               pay_intro,
               device
        from user_album
    </sql>

    <select id="selectListUserAlbum" parameterType="com.xinshijie.gallery.dto.UserAlbumDto"
            resultType="com.xinshijie.gallery.vo.UserAlbumVo">
        <include refid="selectUserAlbum"/>
        <where>
            <if test="id !=null ">and id= #{id}</if>
            <if test="title !=null ">and title= #{title}</if>
            <if test="createTime !=null ">and create_time= #{createTime}</if>
            <if test="updateTime !=null ">and update_time= #{updateTime}</if>
            <if test="userId !=null ">and user_id= #{userId}</if>
            <if test="userName !=null ">and user_name= #{userName}</if>
            <if test="intro !=null ">and intro= #{intro}</if>
            <if test="tags !=null ">and tags= #{tags}</if>
            <if test="vipPrice !=null ">and vip_price= #{vipPrice}</if>
            <if test="charge !=null ">and charge= #{charge}</if>
            <if test="price !=null ">and price= #{price}</if>
            <if test="discount !=null ">and discount= #{discount}</if>
            <if test="girl !=null ">and girl= #{girl}</if>
            <if test="countSee !=null ">and count_see= #{countSee}</if>
            <if test="numberPhotos !=null ">and number_photos= #{numberPhotos}</if>
            <if test="numberVideo !=null ">and number_video= #{numberVideo}</if>
            <if test="countCollection !=null ">and count_collection= #{countCollection}</if>
            <if test="countBuy !=null ">and count_buy= #{countBuy}</if>
            <if test="score !=null ">and score= #{score}</if>
            <if test="introduce !=null ">and introduce= #{introduce}</if>
            <if test="status !=null ">and status= #{status}</if>
            <if test="device == 0 ">and device in (0,1,2)</if>
            <if test="device == 1 ">and device in (0,1)</if>
            <if test="device == 2 ">and device in (0,2)</if>
            <if test="device == null ">and device = 0</if>
        </where>
    </select>

    <select id="selectPageUserAlbum" resultType="com.xinshijie.gallery.domain.UserAlbum">
        <include refid="selectUserAlbum"/>
        <where>
            <if test="dto.id !=null ">and id= #{dto.id}</if>
            <if test="dto.title !=null and dto.title !='' ">and title= #{dto.title}</if>
            <if test="dto.createTime !=null ">and create_time= #{dto.createTime}</if>
            <if test="dto.updateTime !=null ">and update_time= #{dto.updateTime}</if>
            <if test="dto.userId !=null ">and user_id= #{dto.userId}</if>
            <if test="dto.userName !=null ">and user_name= #{dto.userName}</if>
            <if test="dto.intro !=null ">and intro= #{dto.intro}</if>
            <if test="dto.tags !=null ">and tags= #{dto.tags}</if>
            <if test="dto.vipPrice !=null ">and vip_price= #{dto.vipPrice}</if>
            <if test="dto.charge !=null ">and charge= #{dto.charge}</if>
            <if test="dto.price !=null ">and price= #{dto.price}</if>
            <if test="dto.discount !=null ">and discount= #{dto.discount}</if>
            <if test="dto.girl !=null ">and girl= #{dto.girl}</if>
            <if test="dto.score !=null ">and score= #{dto.score}</if>
            <if test="dto.introduce !=null ">and introduce= #{dto.introduce}</if>
            <if test="dto.status !=null ">and status= #{dto.status}</if>
            <if test="dto.device == 1 ">and device= in ( 0,1)</if>
            <if test="dto.device == 2 ">and device= in ( 0,2)</if>
            <if test="dto.device == 0 ">and device= in ( 0,1,2)</if>
            <if test="dto.device ==null ">and device =  0</if>
        </where>
        <if test="dto.orderBy == 'countSee'"> order by count_see desc</if>
        <if test="dto.orderBy == 'createTime'"> order by create_time desc</if>

    </select>

    <select id="getPageUserAlbum" resultType="com.xinshijie.gallery.domain.UserAlbum">
        <include refid="selectUserAlbum"/>
        ${ew.customSqlSegment}
    </select>


    <delete id="delById">
        delete
        FROM user_album
        where id = #{id}
          and user_id = #{userId}
    </delete>

    <update id="updateCountSee">
        update user_album
        set count_see=count_see + 1,
            update_date= #{updateDate}
        where id = #{id}
    </update>

    <select id="getInfo" resultType="com.xinshijie.gallery.vo.UserAlbumVo">
        <include refid="selectUserAlbum"/>
        where id = #{id} and user_id= #{userId}
    </select>

    <select id="previousChapter" resultType="com.xinshijie.gallery.domain.UserAlbum">
        SELECT *
        FROM user_album a
        WHERE a.id &lt; #{id} and  status=1
        <if test="device == 0 ">and device in (0,1,2)</if>
        <if test="device == 1 ">and device in (0,1)</if>
        <if test="device == 2 ">and device in (0,2)</if>
        <if test="device == null ">and device = 0</if>
        ORDER BY id desc
        LIMIT 1
    </select>
    <select id="nextChapter" resultType="com.xinshijie.gallery.domain.UserAlbum">
        SELECT *
        FROM user_album a
        WHERE a.id > #{id} and  status=1
        <if test="device == 0 ">and device in (0,1,2)</if>
        <if test="device == 1 ">and device in (0,1)</if>
        <if test="device == 2 ">and device in (0,2)</if>
        <if test="device == null ">and device = 0</if>
        ORDER BY id
        LIMIT 1 OFFSET 1
    </select>

    <update id="updateCountImage">
        UPDATE user_album
        SET number_photos = (SELECT COUNT(*) FROM user_image where aid = #{id})
        where id = #{id}

    </update>
    <update id="updateCountVideo">
        UPDATE user_album
        SET number_video = (SELECT COUNT(*) FROM user_video where aid = #{id})
        where id = #{id}
    </update>

    <select id="findRandomStories" resultType="com.xinshijie.gallery.domain.UserAlbum">
        SELECT *
        FROM user_album s
        WHERE s.id >= #{randomId} and  status=1
        <if test="device == 0 ">and device in (0,1,2)</if>
        <if test="device == 1 ">and device in (0,1)</if>
        <if test="device == 2 ">and device in (0,2)</if>
        <if test="device == null ">and device = 0</if>
        ORDER BY s.id ASC
        limit #{pageSize}
    </select>
    <select id="findMaxId" resultType="Integer">
        SELECT max(id)
        FROM user_album s
        where   status=1
    </select>
    <select id="findMinId" resultType="Integer">
        SELECT min(id)
        FROM user_album s
        where   status=1

    </select>
</mapper>
